{"version":3,"file":"OrganizationModal-b81f6dbb.js","sources":["../../../../frontend/src/components/Icons/MoneyIcon.vue","../../../../frontend/src/components/Icons/WebsiteIcon.vue","../../../../frontend/src/components/Icons/TerritoryIcon.vue","../../../../frontend/src/components/Modals/OrganizationModal.vue"],"sourcesContent":["<template>\n  <svg\n    xmlns=\"http://www.w3.org/2000/svg\"\n    width=\"16\"\n    height=\"16\"\n    viewBox=\"0 0 24 24\"\n    fill=\"none\"\n    stroke=\"currentColor\"\n    stroke-width=\"1.5\"\n    stroke-linecap=\"round\"\n    stroke-linejoin=\"round\"\n    class=\"lucide lucide-circle-dollar-sign\"\n  >\n    <circle cx=\"12\" cy=\"12\" r=\"10\" />\n    <path d=\"M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8\" />\n    <path d=\"M12 18V6\" />\n  </svg>\n</template>\n","<template>\n  <svg\n    width=\"16\"\n    height=\"16\"\n    viewBox=\"0 0 16 16\"\n    fill=\"none\"\n    xmlns=\"http://www.w3.org/2000/svg\"\n  >\n    <path\n      fill-rule=\"evenodd\"\n      clip-rule=\"evenodd\"\n      d=\"M2.02062 7.49896C2.49506 7.49716 2.97742 7.4933 3.47006 7.48935C3.94277 7.48556 4.42495 7.48169 4.9187 7.47951C4.97589 6.3862 5.14998 5.23014 5.51484 4.17085C5.76241 3.45208 6.1023 2.76557 6.56226 2.17336C4.09972 2.77895 2.23508 4.90491 2.02062 7.49896ZM8 2.1204C7.29452 2.69277 6.79592 3.52219 6.46032 4.49652C6.13931 5.4285 5.97681 6.46734 5.92025 7.4779C6.5896 7.47899 7.28127 7.485 8 7.49989C8.7546 7.48425 9.43077 7.47841 10.0797 7.47777C10.0232 6.46725 9.86068 5.42846 9.53968 4.49651C9.20408 3.52219 8.70548 2.69277 8 2.1204ZM10.0822 8.47771C10.0279 9.50221 9.8654 10.5578 9.53968 11.5035C9.20409 12.4778 8.70548 13.3072 8.00001 13.8796C7.29453 13.3072 6.79592 12.4778 6.46032 11.5035C6.13462 10.5579 5.9721 9.5023 5.91784 8.47784C6.58355 8.47892 7.27164 8.48494 7.98959 8.49989C7.99653 8.50004 8.00347 8.50004 8.01042 8.49989C8.76493 8.48417 9.43715 8.47833 10.0822 8.47771ZM4.91661 8.47951C4.43411 8.48168 3.962 8.48548 3.49714 8.48922C2.99784 8.49323 2.50691 8.49718 2.02045 8.49899C2.2341 11.094 4.09907 13.2209 6.56227 13.8266C6.1023 13.2344 5.76241 12.5479 5.51484 11.8291C5.14541 10.7566 4.97157 9.58487 4.91661 8.47951ZM9.43774 13.8266C9.89771 13.2344 10.2376 12.5479 10.4852 11.8291C10.8545 10.7569 11.0283 9.58549 11.0834 8.48039C11.4269 8.48234 11.771 8.48511 12.1244 8.48796C12.7045 8.49264 13.3098 8.49752 13.9795 8.4993C13.7658 11.0941 11.9008 13.2209 9.43774 13.8266ZM13.9794 7.49928C13.3241 7.49751 12.7264 7.49271 12.1508 7.48809C11.7885 7.48518 11.435 7.48234 11.0814 7.48037C11.0242 6.38681 10.8501 5.23042 10.4852 4.17085C10.2376 3.45208 9.89771 2.76557 9.43774 2.17336C11.9004 2.77897 13.7651 4.90509 13.9794 7.49928ZM1 8C1 4.13401 4.13401 1 8 1C11.866 1 15 4.13401 15 8C15 11.866 11.866 15 8 15C4.13401 15 1 11.866 1 8Z\"\n      fill=\"currentColor\"\n    />\n  </svg>\n</template>\n","<template>\n  <svg\n    xmlns=\"http://www.w3.org/2000/svg\"\n    width=\"16\"\n    height=\"16\"\n    viewBox=\"0 0 24 24\"\n    fill=\"none\"\n    stroke=\"currentColor\"\n    stroke-width=\"1.5\"\n    stroke-linecap=\"round\"\n    stroke-linejoin=\"round\"\n    class=\"lucide lucide-land-plot\"\n  >\n    <path d=\"m12 8 6-3-6-3v10\" />\n    <path\n      d=\"m8 11.99-5.5 3.14a1 1 0 0 0 0 1.74l8.5 4.86a2 2 0 0 0 2 0l8.5-4.86a1 1 0 0 0 0-1.74L16 12\"\n    />\n    <path d=\"m6.49 12.85 11.02 6.3\" />\n    <path d=\"M17.51 12.85 6.5 19.15\" />\n  </svg>\n</template>\n","<template>\n  <Dialog v-model=\"show\" :options=\"dialogOptions\">\n    <template #body>\n      <div class=\"bg-white px-4 pb-6 pt-5 sm:px-6\">\n        <div class=\"mb-5 flex items-center justify-between\">\n          <div>\n            <h3 class=\"text-2xl font-semibold leading-6 text-gray-900\">\n              {{ __(dialogOptions.title) || __('Untitled') }}\n            </h3>\n          </div>\n          <div class=\"flex items-center gap-1\">\n            <Button\n              v-if=\"isManager() || detailMode\"\n              variant=\"ghost\"\n              class=\"w-7\"\n              @click=\"detailMode ? (detailMode = false) : openQuickEntryModal()\"\n            >\n              <EditIcon class=\"h-4 w-4\" />\n            </Button>\n            <Button variant=\"ghost\" class=\"w-7\" @click=\"show = false\">\n              <FeatherIcon name=\"x\" class=\"h-4 w-4\" />\n            </Button>\n          </div>\n        </div>\n        <div>\n          <div v-if=\"detailMode\" class=\"flex flex-col gap-3.5\">\n            <div\n              class=\"flex h-7 items-center gap-2 text-base text-gray-800\"\n              v-for=\"field in fields\"\n              :key=\"field.name\"\n            >\n              <div class=\"grid w-7 place-content-center\">\n                <component :is=\"field.icon\" />\n              </div>\n              <div>{{ field.value }}</div>\n            </div>\n          </div>\n          <Fields\n            v-else-if=\"filteredSections\"\n            :sections=\"filteredSections\"\n            :data=\"_organization\"\n          />\n        </div>\n      </div>\n      <div v-if=\"!detailMode\" class=\"px-4 pb-7 pt-4 sm:px-6\">\n        <div class=\"space-y-2\">\n          <Button\n            class=\"w-full\"\n            v-for=\"action in dialogOptions.actions\"\n            :key=\"action.label\"\n            v-bind=\"action\"\n            :label=\"__(action.label)\"\n            :loading=\"loading\"\n          />\n        </div>\n      </div>\n    </template>\n  </Dialog>\n  <AddressModal v-model=\"showAddressModal\" v-model:address=\"_address\" />\n</template>\n\n<script setup>\nimport Fields from '@/components/Fields.vue'\nimport AddressModal from '@/components/Modals/AddressModal.vue'\nimport EditIcon from '@/components/Icons/EditIcon.vue'\nimport MoneyIcon from '@/components/Icons/MoneyIcon.vue'\nimport WebsiteIcon from '@/components/Icons/WebsiteIcon.vue'\nimport OrganizationsIcon from '@/components/Icons/OrganizationsIcon.vue'\nimport TerritoryIcon from '@/components/Icons/TerritoryIcon.vue'\nimport { usersStore } from '@/stores/users'\nimport { formatNumberIntoCurrency } from '@/utils'\nimport { capture } from '@/telemetry'\nimport { call, FeatherIcon, createResource } from 'frappe-ui'\nimport { ref, nextTick, watch, computed, h } from 'vue'\nimport { useRouter } from 'vue-router'\n\nconst props = defineProps({\n  options: {\n    type: Object,\n    default: {\n      redirect: true,\n      detailMode: false,\n      afterInsert: () => {},\n    },\n  },\n})\n\nconst { isManager } = usersStore()\n\nconst router = useRouter()\nconst show = defineModel()\nconst organization = defineModel('organization')\n\nconst loading = ref(false)\nconst title = ref(null)\nconst detailMode = ref(false)\nconst editMode = ref(false)\nlet _address = ref({})\nlet _organization = ref({\n  organization_name: '',\n  website: '',\n  annual_revenue: '',\n  no_of_employees: '1-10',\n  industry: '',\n})\n\nconst showAddressModal = ref(false)\n\nlet doc = ref({})\n\nasync function updateOrganization() {\n  const old = { ...doc.value }\n  const newOrg = { ..._organization.value }\n\n  const nameChanged = old.organization_name !== newOrg.organization_name\n  delete old.organization_name\n  delete newOrg.organization_name\n\n  const otherFieldChanged = JSON.stringify(old) !== JSON.stringify(newOrg)\n  const values = newOrg\n\n  if (!nameChanged && !otherFieldChanged) {\n    show.value = false\n    return\n  }\n\n  let name\n  loading.value = true\n  if (nameChanged) {\n    name = await callRenameDoc()\n  }\n  if (otherFieldChanged) {\n    name = await callSetValue(values)\n  }\n  handleOrganizationUpdate({ name }, nameChanged)\n}\n\nasync function callRenameDoc() {\n  const d = await call('frappe.client.rename_doc', {\n    doctype: 'CRM Organization',\n    old_name: doc.value?.organization_name,\n    new_name: _organization.value.organization_name,\n  })\n  loading.value = false\n  return d\n}\n\nasync function callSetValue(values) {\n  const d = await call('frappe.client.set_value', {\n    doctype: 'CRM Organization',\n    name: _organization.value.name,\n    fieldname: values,\n  })\n  loading.value = false\n  return d.name\n}\n\nasync function callInsertDoc() {\n  const doc = await call('frappe.client.insert', {\n    doc: {\n      doctype: 'CRM Organization',\n      ..._organization.value,\n    },\n  })\n  loading.value = false\n  if (doc.name) {\n    capture('organization_created')\n    handleOrganizationUpdate(doc)\n  }\n}\n\nfunction handleOrganizationUpdate(doc, renamed = false) {\n  if (doc.name && (props.options.redirect || renamed)) {\n    router.push({\n      name: 'Organization',\n      params: { organizationId: doc.name },\n    })\n  } else {\n    organization.value.reload?.()\n  }\n  show.value = false\n  props.options.afterInsert && props.options.afterInsert(doc)\n}\n\nconst dialogOptions = computed(() => {\n  let title = !editMode.value\n    ? __('New Organization')\n    : __(_organization.value.organization_name)\n  let size = detailMode.value ? '' : 'xl'\n  let actions = detailMode.value\n    ? []\n    : [\n        {\n          label: editMode.value ? __('Save') : __('Create'),\n          variant: 'solid',\n          onClick: () =>\n            editMode.value ? updateOrganization() : callInsertDoc(),\n        },\n      ]\n\n  return { title, size, actions }\n})\n\nconst fields = computed(() => {\n  let details = [\n    {\n      icon: OrganizationsIcon,\n      name: 'organization_name',\n      value: _organization.value.organization_name,\n    },\n    {\n      icon: WebsiteIcon,\n      name: 'website',\n      value: _organization.value.website,\n    },\n    {\n      icon: TerritoryIcon,\n      name: 'territory',\n      value: _organization.value.territory,\n    },\n    {\n      icon: MoneyIcon,\n      name: 'annual_revenue',\n      value: formatNumberIntoCurrency(\n        _organization.value.annual_revenue,\n        _organization.value.currency,\n      ),\n    },\n    {\n      icon: h(FeatherIcon, { name: 'hash', class: 'h-4 w-4' }),\n      name: 'no_of_employees',\n      value: _organization.value.no_of_employees,\n    },\n    {\n      icon: h(FeatherIcon, { name: 'briefcase', class: 'h-4 w-4' }),\n      name: 'industry',\n      value: _organization.value.industry,\n    },\n  ]\n\n  return details.filter((field) => field.value)\n})\n\nconst sections = createResource({\n  url: 'crm.fcrm.doctype.crm_fields_layout.crm_fields_layout.get_fields_layout',\n  cache: ['quickEntryFields', 'CRM Organization'],\n  params: { doctype: 'CRM Organization', type: 'Quick Entry' },\n  auto: true,\n})\n\nconst filteredSections = computed(() => {\n  let allSections = sections.data || []\n  if (!allSections.length) return []\n\n  allSections.forEach((s) => {\n    s.fields.forEach((field) => {\n      if (field.name == 'address') {\n        field.create = (value, close) => {\n          _organization.value.address = value\n          _address.value = {}\n          showAddressModal.value = true\n          close()\n        }\n        field.edit = async (addr) => {\n          _address.value = await call('frappe.client.get', {\n            doctype: 'Address',\n            name: addr,\n          })\n          showAddressModal.value = true\n        }\n      }\n    })\n  })\n\n  return allSections\n})\n\nwatch(\n  () => show.value,\n  (value) => {\n    if (!value) return\n    editMode.value = false\n    detailMode.value = props.options.detailMode\n    nextTick(() => {\n      // TODO: Issue with FormControl\n      // title.value.el.focus()\n      doc.value = organization.value?.doc || organization.value || {}\n      _organization.value = { ...doc.value }\n      if (_organization.value.name) {\n        editMode.value = true\n      }\n    })\n  },\n)\n\nconst showQuickEntryModal = defineModel('quickEntry')\n\nfunction openQuickEntryModal() {\n  showQuickEntryModal.value = true\n  nextTick(() => {\n    show.value = false\n  })\n}\n</script>\n"],"names":["_hoisted_1","_sfc_render","_ctx","_cache","_openBlock","_createElementBlock","_createElementVNode","props","__props","isManager","usersStore","router","useRouter","show","_useModel","organization","loading","ref","detailMode","editMode","_address","_organization","showAddressModal","doc","updateOrganization","old","newOrg","nameChanged","otherFieldChanged","values","name","callRenameDoc","callSetValue","handleOrganizationUpdate","d","call","_a","callInsertDoc","capture","renamed","_b","dialogOptions","computed","title","size","actions","fields","OrganizationsIcon","WebsiteIcon","TerritoryIcon","MoneyIcon","formatNumberIntoCurrency","h","FeatherIcon","field","sections","createResource","filteredSections","allSections","s","value","close","addr","watch","nextTick","showQuickEntryModal","openQuickEntryModal"],"mappings":"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"}