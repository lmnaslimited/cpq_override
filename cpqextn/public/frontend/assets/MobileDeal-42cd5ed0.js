import{_ as ye}from"./Icon-b0abef9d.js";import{D as he}from"./DetailsIcon-ef5d1277.js";import{u as be,A as xe,E as Ce,S as we,L as Ie,_ as ke}from"./useActiveTabManager-eb58b00a.js";import{E as De}from"./Email2Icon-e2d51718.js";import{C as Ve}from"./CommentIcon-2f8212cd.js";import{P as Y}from"./PhoneIcon-d45a62b6.js";import{h as ze,v as Se,l as y,x as V,I as z,a as $e,j as Z,r as j,b as i,c,u as t,g as v,w as m,p as _,G as Ae,e as u,d as r,L as N,F,T as Te,n as T,f as ee,t as S,H as ae,B as Ue}from"./index-d057f33a.js";import{N as Me}from"./NoteModal-46cc4fb1.js";import{W as Ee}from"./WhatsAppIcon-3fd08937.js";import{I as Re}from"./IndicatorIcon-c103771d.js";import{A as qe}from"./ArrowUpRightIcon-f89323ee.js";import{S as Be}from"./Fields-6a34413d.js";import{_ as Le}from"./LayoutHeader-fe1f254b.js";import{_ as je}from"./OrganizationModal-b81f6dbb.js";import{_ as Ne}from"./AssignmentModal-7b9977f2.js";import{_ as Fe}from"./MultipleAvatar-9bfce769.js";import{C as Oe}from"./ContactModal-53eff54c.js";import{_ as Pe}from"./views-fe454bb1.js";import{_ as te}from"./Section-1565df09.js";import{S as We}from"./SLASection-51b98e40.js";import{_ as Ge}from"./CustomActions-fd13eb50.js";import{g as He,h,s as Je,i as Ke,b as Qe}from"./UserAvatar-e49c5291.js";import{g as Xe,_ as Ye}from"./view-66caf033.js";import{s as Ze}from"./statuses-72592e37.js";import{i as ea,c as aa,w as ta}from"./settings-0248bbea.js";import{_ as oa}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-7b2c30ed.js";import{_ as oe}from"./Dropdown.vue_vue_type_script_setup_true_lang-bf1a1150.js";import"./CalendarIcon-236853ad.js";import"./callLog-55eb7109.js";import"./contacts-62bb23c5.js";import"./Dropdown-ddb0640f.js";import"./FadedScrollableDiv-9f66556a.js";import"./FileUploader-1f4a7957.js";import"./LeadsIcon-520efb00.js";import"./DealsIcon-15068e15.js";import"./EmailTemplateModal-9954264c.js";import"./TaskModal-817b477f.js";import"./EditIcon-a130850d.js";import"./NestedPopover-545deb9d.js";import"./AddressModal-ced65781.js";import"./QuickEntryModal-6386ea24.js";import"./DragVerticalIcon-87005af9.js";import"./Switch.vue_vue_type_script_setup_true_lang-3dc67c0d.js";import"./GroupByIcon-a605d43f.js";import"./OrganizationsIcon-321405d1.js";const sa={class:"relative flex h-12 items-center justify-between gap-2 py-2.5 pl-5"},na={class:"absolute right-0"},la={key:1,class:"flex h-12 items-center justify-between gap-2 border-b px-3 py-2.5"},ia={class:"flex items-center gap-2"},ra={key:2,class:"flex h-full overflow-hidden"},da={key:0},ma={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},ca={class:"flex flex-col overflow-y-auto"},ua={key:0,class:"pr-2"},pa={key:1},_a={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},fa={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},va=["onClick"],ga={class:"truncate"},ya={class:"flex items-center"},ha={class:"flex flex-col gap-1.5 text-base text-gray-800"},ba={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},xa={class:"flex items-center gap-3 p-1 py-1.5"},Ca={key:0,class:"mx-2 h-px border-t border-gray-200"},wa={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},ft={__name:"MobileDeal",props:{dealId:{type:String,required:!0}},setup(se){const{$dialog:ne,$socket:le}=He(),{statusOptions:ie,getDealStatus:re}=Ze(),b=ze(),$=Se(),f=se,U=y([]),O=y([]),o=V({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:f.dealId},cache:["deal",f.dealId],onSuccess:async a=>{a.organization&&(M.update({params:{doctype:"CRM Organization",name:a.organization}}),M.fetch());let e={doc:a,$dialog:ne,$socket:le,router:$,updateField:k,createToast:h,deleteDoc:ve,resource:{deal:o,dealContacts:w,fieldsLayout:C},call:z};Je(a);let s=await Ke(a,e);U.value=s.actions||[],O.value=s.statuses||[]}}),M=V({url:"frappe.client.get",onSuccess:a=>o.data._organizationObj=a});$e(()=>{o.data||o.fetch()});const E=y(!1),R=y(!1),A=y(!1),q=y({});function de(a,e,s){e=Array.isArray(a)?"":e,!me(a,e)&&V({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:f.dealId,fieldname:a,value:e},auto:!0,onSuccess:()=>{o.reload(),E.value=!0,h({title:__("Deal updated"),icon:"check",iconClasses:"text-green-600"}),s==null||s()},onError:n=>{var I;h({title:__("Error updating deal"),text:__((I=n.messages)==null?void 0:I[0]),icon:"x",iconClasses:"text-red-600"})}})}function me(a,e){var n;let s=o.data.fields_meta||{};return(n=s[a])!=null&&n.reqd&&!e?(h({title:__("Error Updating Deal"),text:__("{0} is a required field",[s[a].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const ce=Z(()=>{var e;let a=[{label:__("Deals"),route:{name:"Deals"}}];if(b.query.view||b.query.viewType){let s=Xe(b.query.view,b.query.viewType,"CRM Deal");s&&a.push({label:__(s.label),icon:s.icon,route:{name:"Deals",params:{viewType:b.query.viewType},query:{view:b.query.view}}})}return a.push({label:((e=M.data)==null?void 0:e.name)||__("Untitled"),route:{name:"Deal",params:{dealId:o.data.name}}}),a}),B=Z(()=>[{name:"Details",label:__("Details"),icon:he,condition:()=>ea.value},{name:"Activity",label:__("Activity"),icon:xe},{name:"Emails",label:__("Emails"),icon:Ce},{name:"Comments",label:__("Comments"),icon:Ve},{name:"Calls",label:__("Calls"),icon:Y,condition:()=>aa.value},{name:"Tasks",label:__("Tasks"),icon:Te},{name:"Notes",label:__("Notes"),icon:Me},{name:"WhatsApp",label:__("WhatsApp"),icon:Ee,condition:()=>ta.value}].filter(e=>e.condition?e.condition():!0)),{tabIndex:x}=be(B,"lastDealTab"),C=V({url:"crm.api.doc.get_sidebar_fields",cache:["fieldsLayout",f.dealId],params:{doctype:"CRM Deal",name:f.dealId},auto:!0,transform:a=>ue(a)});function ue(a){return a.forEach(e=>{e.name!="contacts_section"&&e.fields.forEach(s=>{s.name=="organization"&&(s.create=(n,I)=>{q.value.organization_name=n,R.value=!0,I()},s.link=n=>$.push({name:"Organization",params:{organizationId:n}}))})}),a}const L=y(!1),P=y({});function pe(a){let e=[{label:__("Delete"),icon:"trash-2",onClick:()=>_e(a)}];return a.is_primary||e.push({label:__("Set as Primary Contact"),icon:Ue(Be,{class:"h-4 w-4"}),onClick:()=>fe(a.name)}),e}async function W(a){await z("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:f.dealId,contact:a})&&(w.reload(),h({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function _e(a){await z("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:f.dealId,contact:a})&&(w.reload(),h({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function fe(a){await z("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:f.dealId,contact:a})&&(w.reload(),h({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const w=V({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:f.dealId},cache:["deal_contacts",f.dealId],auto:!0,onSuccess:a=>{var s;let e=(s=C.data)==null?void 0:s.find(n=>n.name=="contacts_section");e&&(e.contacts=a.map(n=>({name:n.name,full_name:n.full_name,email:n.email,mobile_no:n.mobile_no,image:n.image,is_primary:n.is_primary,opened:!1})))}});function k(a,e,s){de(a,e,()=>{o.data[a]=e,s==null||s()})}async function ve(a){await z("frappe.client.delete",{doctype:"CRM Deal",name:a}),$.push({name:"Deals"})}return(a,e)=>{var G;const s=j("FeatherIcon"),n=j("Button"),I=j("Badge");return i(),c(F,null,[t(o).data?(i(),v(Le,{key:0},{default:m(()=>[u("header",sa,[r(t(oa),{items:ce.value},{prefix:m(({item:l})=>[l.icon?(i(),v(ye,{key:0,icon:l.icon,class:"mr-2 h-4"},null,8,["icon"])):_("",!0)]),_:1},8,["items"]),u("div",na,[r(t(oe),{options:t(ie)("deal",k,O.value)},{default:m(({open:l})=>[r(n,{label:t(o).data.status,class:T(t(re)(t(o).data.status).colorClass)},{prefix:m(()=>[r(Re)]),suffix:m(()=>[r(s,{name:l?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])])])]),_:1})):_("",!0),t(o).data?(i(),c("div",la,[(i(),v(Ae(((G=t(o).data._assignedTo)==null?void 0:G.length)==1?"Button":"div"),null,{default:m(()=>[r(Fe,{avatars:t(o).data._assignedTo,onClick:e[0]||(e[0]=l=>A.value=!0)},null,8,["avatars"])]),_:1})),u("div",ia,[U.value?(i(),v(Ge,{key:0,actions:U.value},null,8,["actions"])):_("",!0)])])):_("",!0),t(o).data?(i(),c("div",ra,[r(t(Ye),{modelValue:t(x),"onUpdate:modelValue":e[7]||(e[7]=l=>N(x)?x.value=l:null),tabs:B.value,tablistClass:"!px-3",class:"overflow-auto"},{default:m(({tab:l})=>[l.name=="Details"?(i(),c("div",da,[t(o).data.sla_status?(i(),v(We,{key:0,modelValue:t(o).data,"onUpdate:modelValue":e[1]||(e[1]=d=>t(o).data=d),onUpdateField:k},null,8,["modelValue"])):_("",!0),t(C).data?(i(),c("div",ma,[u("div",ca,[(i(!0),c(F,null,ee(t(C).data,(d,H)=>(i(),c("div",{key:d.label,class:T(["flex flex-col px-2 py-3 sm:p-3",{"border-b":H!==t(C).data.length-1}])},[r(te,{"is-opened":d.opened,label:d.label},{actions:m(()=>[d.contacts?(i(),c("div",ua,[r(Pe,{value:"",doctype:"Contact",onChange:e[2]||(e[2]=g=>W(g)),onCreate:(g,D)=>{P.value={first_name:g,company_name:t(o).data.organization},L.value=!0,D()}},{target:m(({togglePopover:g})=>[r(n,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:D=>g()},null,8,["onClick"])]),_:1},8,["onCreate"])])):_("",!0)]),default:m(()=>{var g,D,J;return[d.fields?(i(),v(we,{key:0,fields:d.fields,isLastSection:H==t(C).data.length-1,modelValue:t(o).data,"onUpdate:modelValue":e[3]||(e[3]=p=>t(o).data=p),onUpdate:k},null,8,["fields","isLastSection","modelValue"])):(i(),c("div",pa,[(g=t(w))!=null&&g.loading&&((J=(D=t(w))==null?void 0:D.data)==null?void 0:J.length)==0?(i(),c("div",_a,[r(Ie,{class:"h-4 w-4"}),u("span",null,S(a.__("Loading...")),1)])):d.contacts.length?(i(!0),c(F,{key:1},ee(d.contacts,(p,K)=>(i(),c("div",{key:p.name},[u("div",{class:T(["px-2 pb-2.5",[K==0?"pt-5":"pt-2.5"]])},[r(te,{"is-opened":p.opened},{header:m(({opened:ge,toggle:Q})=>[u("div",fa,[u("div",{class:"flex h-7 items-center gap-2 truncate",onClick:X=>Q()},[r(t(Qe),{label:p.full_name,image:p.image,size:"md"},null,8,["label","image"]),u("div",ga,S(p.full_name),1),p.is_primary?(i(),v(I,{key:0,class:"ml-2",variant:"outline",label:a.__("Primary"),theme:"green"},null,8,["label"])):_("",!0)],8,va),u("div",ya,[r(t(oe),{options:pe(p.name)},{default:m(()=>[r(n,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),r(n,{variant:"ghost",onClick:X=>t($).push({name:"Contact",params:{contactId:p.name}})},{default:m(()=>[r(qe,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),r(n,{variant:"ghost",onClick:X=>Q()},{default:m(()=>[r(s,{name:"chevron-right",class:T(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":ge}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:m(()=>[u("div",ha,[u("div",ba,[r(De,{class:"h-4 w-4"}),ae(" "+S(p.email),1)]),u("div",xa,[r(Y,{class:"h-4 w-4"}),ae(" "+S(p.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),K!=d.contacts.length-1?(i(),c("div",Ca)):_("",!0)]))),128)):(i(),c("div",wa,S(a.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):_("",!0)])):(i(),v(ke,{key:1,doctype:"CRM Deal",tabs:B.value,reload:E.value,"onUpdate:reload":e[4]||(e[4]=d=>E.value=d),tabIndex:t(x),"onUpdate:tabIndex":e[5]||(e[5]=d=>N(x)?x.value=d:null),modelValue:t(o),"onUpdate:modelValue":e[6]||(e[6]=d=>N(o)?o.value=d:null)},null,8,["tabs","reload","tabIndex","modelValue"]))]),_:1},8,["modelValue","tabs"])])):_("",!0),r(je,{modelValue:R.value,"onUpdate:modelValue":e[8]||(e[8]=l=>R.value=l),organization:q.value,"onUpdate:organization":e[9]||(e[9]=l=>q.value=l),options:{redirect:!1,afterInsert:l=>k("organization",l.name)}},null,8,["modelValue","organization","options"]),r(Oe,{modelValue:L.value,"onUpdate:modelValue":e[10]||(e[10]=l=>L.value=l),contact:P.value,options:{redirect:!1,afterInsert:l=>W(l.name)}},null,8,["modelValue","contact","options"]),A.value?(i(),v(Ne,{key:3,modelValue:A.value,"onUpdate:modelValue":e[11]||(e[11]=l=>A.value=l),assignees:t(o).data._assignedTo,"onUpdate:assignees":e[12]||(e[12]=l=>t(o).data._assignedTo=l),doc:t(o).data,doctype:"CRM Deal"},null,8,["modelValue","assignees","doc"])):_("",!0)],64)}}};export{ft as default};
//# sourceMappingURL=MobileDeal-42cd5ed0.js.map
