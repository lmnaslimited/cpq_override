{"version":3,"file":"Design-1a9fc2fa.js","sources":["../../../../frontend/src/pages/Design.vue"],"sourcesContent":["<template>\n  <LayoutHeader v-if=\"design.data\">\n    <template #left-header>\n      <Breadcrumbs :items=\"breadcrumbs\">\n        <template #prefix=\"{ item }\">\n          <Icon v-if=\"item.icon\" :icon=\"item.icon\" class=\"mr-2 h-4\" />\n        </template>\n      </Breadcrumbs>\n    </template>\n    <template #right-header>\n      <CustomActions v-if=\"customActions\" :actions=\"customActions\" />\n          <Button\n            :label=\"design.data.status\"\n          >\n            <template #prefix>\n              <IndicatorIcon />\n            </template>\n          </Button>\n      <Button\n        v-if=\"!design.data.item\"\n        :label=\"__('Create Item')\"\n        variant=\"solid\"\n        :loading=\"isItemCreating\"\n        @click=\"createItem\" \n      />\n      <Button\n        v-if=\"design.data.item\"\n        :label=\"__('View Item')\"\n        variant=\"solid\"\n        @click=\"viewItem\"\n      />\n    </template>\n  </LayoutHeader>\n  <div v-if=\"design?.data\" class=\"flex h-full overflow-hidden\">\n    <Tabs v-model=\"tabIndex\" v-slot=\"{ tab }\" :tabs=\"tabs\">\n      <Activities\n        ref=\"activities\"\n        doctype=\"Design\"\n        :tabs=\"tabs\"\n        v-model:reload=\"reload\"\n        v-model:tabIndex=\"tabIndex\"\n        v-model=\"design\"\n      />\n    </Tabs>\n    <Resizer class=\"flex flex-col justify-between border-l\" side=\"right\">\n      <div\n        class=\"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium\"\n        @click=\"copyToClipboard(design.data.name)\"\n      >\n        {{ __(design.data.name) }}\n      </div>\n     \n      <!-- <SLASection\n        v-if=\"design.data.sla_status\"\n        v-model=\"design.data\"\n        @updateField=\"updateField\"\n      /> -->\n      <div\n        v-if=\"fieldsLayout.data\"\n        class=\"flex flex-1 flex-col justify-between overflow-hidden\"\n      >\n        <div class=\"flex flex-col overflow-y-auto\">\n          <div\n            v-for=\"(section, i) in fieldsLayout.data\"\n            :key=\"section.label\"\n            class=\"flex flex-col p-3\"\n            :class=\"{ 'border-b': i !== fieldsLayout.data.length - 1 }\"\n          >\n            <Section :is-opened=\"section.opened\" :label=\"section.label\">\n              <SectionFieldCpq\n                :fields=\"section.fields\"\n                :isLastSection=\"i == fieldsLayout.data.length - 1\"\n                v-model=\"design.data\"\n                @update=\"updateField\"\n              />\n              <!-- <template v-if=\"i == 0 && isManager()\" #actions>\n                <Button\n                  variant=\"ghost\"\n                  class=\"w-7 mr-2\"\n                  @click=\"showSidePanelModal = true\"\n                >\n                  <EditIcon class=\"h-4 w-4\" />\n                </Button>\n              </template> -->\n            </Section>\n          </div>\n        </div>\n      </div>\n    </Resizer>\n  </div>\n  <AssignmentModal\n    v-if=\"showAssignmentModal\"\n    v-model=\"showAssignmentModal\"\n    v-model:assignees=\"design.data._assignedTo\"\n    :doc=\"design.data\"\n    doctype=\"Design\"\n  />\n  <SidePanelModal\n    v-if=\"showSidePanelModal\"\n    v-model=\"showSidePanelModal\"\n    @reload=\"() => fieldsLayout.reload()\"\n  />\n</template>\n<script setup>\nimport Icon from '@/components/Icon.vue'\nimport Resizer from '@/components/Resizer.vue'\nimport EditIcon from '@/components/Icons/EditIcon.vue'\nimport ActivityIcon from '@/components/Icons/ActivityIcon.vue'\nimport EmailIcon from '@/components/Icons/EmailIcon.vue'\nimport CommentIcon from '@/components/Icons/CommentIcon.vue'\nimport PhoneIcon from '@/components/Icons/PhoneIcon.vue'\nimport TaskIcon from '@/components/Icons/TaskIcon.vue'\nimport NoteIcon from '@/components/Icons/NoteIcon.vue'\nimport WhatsAppIcon from '@/components/Icons/WhatsAppIcon.vue'\nimport IndicatorIcon from '@/components/Icons/IndicatorIcon.vue'\nimport LayoutHeader from '@/components/LayoutHeader.vue'\nimport Activities from '@/components/Activities/Activities.vue'\nimport AssignmentModal from '@/components/Modals/AssignmentModal.vue'\nimport SidePanelModal from '@/components/Settings/SidePanelModal.vue'\nimport MultipleAvatar from '@/components/MultipleAvatar.vue'\nimport Section from '@/components/Section.vue'\nimport SectionFieldCpq from '@/components/SectionFieldCpq.vue'\nimport SLASection from '@/components/SLASection.vue'\nimport CustomActions from '@/components/CustomActions.vue'\nimport {\n  createToast,\n  setupAssignees,\n  setupCustomizations,\n  copyToClipboard,\n} from '@/utils'\nimport { getView } from '@/utils/view'\nimport { globalStore } from '@/stores/global'\nimport { contactsStore } from '@/stores/contacts'\nimport { statusesStore } from '@/stores/statuses'\nimport { usersStore } from '@/stores/users'\nimport { whatsappEnabled, callEnabled } from '@/composables/settings'\nimport { capture } from '@/telemetry'\nimport {\n  createResource,\n  FileUploader,\n  Dropdown,\n  Tooltip,\n  Avatar,\n  Tabs,\n  Switch,\n  Breadcrumbs,\n  call,\n  usePageMeta,\n} from 'frappe-ui'\nimport { ref, computed, onMounted, watch } from 'vue'\nimport { useRouter, useRoute } from 'vue-router'\nimport { useActiveTabManager } from '@/composables/useActiveTabManager'\n\nconst { $dialog, $socket, makeCall } = globalStore()\nconst { getContactByName, contacts } = contactsStore()\nconst { statusOptions, getLeadStatus } = statusesStore()\nconst { isManager } = usersStore()\nconst route = useRoute()\nconst router = useRouter()\nconst isItemCreating = ref(false)\n\nconst props = defineProps({\n  designId: {\n    type: String,\n    required: true,\n  },\n})\n\nconst customActions = ref([])\nconst customStatuses = ref([])\n\nconst design = createResource({\n  url: 'crm.cpq.doctype.design.api.get_design',\n  params: { name: props.designId },\n  cache: ['design', props.designId],\n  onSuccess: async (data) => {\n    let obj = {\n      doc: data,\n      $dialog,\n      $socket,\n      router,\n      updateField,\n      createToast,\n      deleteDoc: deleteDesign,\n      resource: {\n        design,\n        fieldsLayout,\n      },\n      call,\n    }\n    setupAssignees(data)\n    let customization = await setupCustomizations(data, obj)\n    customActions.value = customization.actions || []\n    customStatuses.value = customization.statuses || []\n  },\n})\n\nonMounted(() => {\n  if (design.data) return\n  design.fetch().catch((err) => {\n});\n})\n\nconst reload = ref(false)\nconst showAssignmentModal = ref(false)\nconst showSidePanelModal = ref(false)\n\nfunction updateDesign(fieldname, value, callback) {\n  value = Array.isArray(fieldname) ? '' : value\n\n  if (!Array.isArray(fieldname) && validateRequired(fieldname, value)) return\n\n  createResource({\n    url: 'frappe.client.set_value',\n    params: {\n      doctype: 'Design',\n      name: props.designId,\n      fieldname,\n      value,\n    },\n    auto: true,\n    onSuccess: () => {\n      design.reload()\n      reload.value = true\n      createToast({\n        title: __('Design updated'),\n        icon: 'check',\n        iconClasses: 'text-green-600',\n      })\n      callback?.()\n    },\n    onError: (err) => {\n      createToast({\n        title: __('Error updating design'),\n        text: __(err.messages?.[0]),\n        icon: 'x',\n        iconClasses: 'text-red-600',\n      })\n    },\n  })\n}\n\nfunction validateRequired(fieldname, value) {\n  let meta = design.data.fields_meta || {}\n  if (meta[fieldname]?.reqd && !value) {\n    createToast({\n      title: __('Error Updating Design'),\n      text: __('{0} is a required field', [meta[fieldname].label]),\n      icon: 'x',\n      iconClasses: 'text-red-600',\n    })\n    return true\n  }\n  return false\n}\n\nconst breadcrumbs = computed(() => {\n  let items = [{ label: __('Designs'), route: { name: 'Designs' } }]\n\n  if (route.query.view || route.query.viewType) {\n    let view = getView(route.query.view, route.query.viewType, 'Design')\n    if (view) {\n      items.push({\n        label: __(view.label),\n        icon: view.icon,\n        route: {\n          name: 'Designs',\n          params: { viewType: route.query.viewType },\n          query: { view: route.query.view },\n        },\n      })\n    }\n  }\n\n  items.push({\n    label: design.data.name || __('Untitled'),\n    route: { name: 'Design', params: { designId: design.data.name } },\n  })\n  return items\n})\n\nusePageMeta(() => {\n  return {\n    title: design.data?.name || design.data?.name,\n  }\n})\n\nconst tabs = computed(() => {\n  let tabOptions = [\n    {\n      name: 'Activity',\n      label: __('Activity'),\n      icon: ActivityIcon,\n    },\n    {\n      name: 'Emails',\n      label: __('Emails'),\n      icon: EmailIcon,\n    },\n    {\n      name: 'Comments',\n      label: __('Comments'),\n      icon: CommentIcon,\n    },\n    {\n      name: 'Calls',\n      label: __('Calls'),\n      icon: PhoneIcon,\n      condition: () => callEnabled.value,\n    },\n    {\n      name: 'Tasks',\n      label: __('Tasks'),\n      icon: TaskIcon,\n    },\n    {\n      name: 'Notes',\n      label: __('Notes'),\n      icon: NoteIcon,\n    },\n    {\n      name: 'WhatsApp',\n      label: __('WhatsApp'),\n      icon: WhatsAppIcon,\n      condition: () => whatsappEnabled.value,\n    },\n  ]\n  return tabOptions.filter((tab) => (tab.condition ? tab.condition() : true))\n})\n\nconst { tabIndex } = useActiveTabManager(tabs, 'lastDesignTab')\n\nwatch(tabs, (value) => {\n  if (value && route.params.tabName) {\n    let index = value.findIndex(\n      (tab) => tab.name.toLowerCase() === route.params.tabName.toLowerCase(),\n    )\n    if (index !== -1) {\n      tabIndex.value = index\n    }\n  }\n})\n\nwatch(\n  () => design.data?.direct_material_cost,\n  (newValue, oldValue) => {\n    const newCost = Number(newValue);\n    const oldCost = Number(oldValue);\n\n    if (!Number.isNaN(newCost) && !Number.isNaN(oldCost)) {\n      if (newCost !== oldCost) {\n        // Only update total_cost if newCost is different from oldCost\n        console.log(\"Value changed:\", oldCost, newCost);\n        updateField(\"total_cost\", newCost);\n      } else {\n        console.log(\"No change in value:\", oldCost, newCost);\n      }\n    } else {\n      console.log(\"Skipping update due to NaN value:\", \"newCost:\", newCost, \"oldCost:\", oldCost);\n    }\n  },\n  { immediate: false }\n)\n\nconst fieldsLayout = createResource({\n  url: 'crm.api.docCpq.get_sidebar_fields_with_table',\n  cache: ['fieldsLayout', props.designId],\n  params: { doctype: 'Design', name: props.designId },\n  auto: true,\n})\n\nconst createItem = () => {\n  isItemCreating.value = true;\n  createResource({\n    url: 'crm.api.docCpq.create_item_from_design',\n    params: { design_name: props.designId },\n    onSuccess: (data) => {\n      isItemCreating.value = false;\n      updateField(\"item\", data)\n      createToast({\n        title: __('Item created successfully'),\n        icon: 'check',\n        iconClasses: 'text-green-600',\n      })\n      \n    },\n    onError: (err) => {\n      isItemCreating.value = false;\n      createToast({\n        title: __('Error creating item'),\n        text: __(err.messages?.[0] || 'Failed to create item'),\n        icon: 'x',\n        iconClasses: 'text-red-600',\n      })\n    },\n  }).fetch()\n}\n\nconst viewItem = async () => {\n  if (design.data.item) {\n   router.push({ name: 'Item', params: { itemId: design.data.item } });\n  }\n};\n\n\nfunction updateField(name, value, callback) {\n  updateDesign(name, value, () => {\n    design.data[name] = value\n    callback?.()\n  })\n}\n\nasync function deleteDesign(name) {\n  await call('frappe.client.delete', {\n    doctype: 'Design',\n    name,\n  })\n  router.push({ name: 'Designs' })\n}\n\n</script>"],"names":["$dialog","$socket","makeCall","globalStore","contactsStore","statusesStore","usersStore","route","useRoute","router","useRouter","isItemCreating","ref","props","__props","customActions","customStatuses","design","createResource","data","obj","updateField","createToast","deleteDesign","fieldsLayout","call","setupAssignees","customization","setupCustomizations","onMounted","err","reload","showAssignmentModal","showSidePanelModal","updateDesign","fieldname","value","callback","validateRequired","_a","meta","breadcrumbs","computed","items","view","getView","usePageMeta","_b","tabs","ActivityIcon","EmailIcon","CommentIcon","PhoneIcon","callEnabled","TaskIcon","NoteIcon","WhatsAppIcon","whatsappEnabled","tab","tabIndex","useActiveTabManager","watch","index","newValue","oldValue","newCost","oldCost","createItem","viewItem","name"],"mappings":"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"}