import{_ as Se}from"./Icon-b0abef9d.js";import{_ as Ue,a as Me}from"./SidePanelModal-05261a36.js";import{u as Ee,A as Te,E as Ae,_ as Re,S as Be,L as Ne}from"./useActiveTabManager-eb58b00a.js";import{E as Le}from"./EditIcon-a130850d.js";import{E as ne}from"./Email2Icon-e2d51718.js";import{C as je}from"./CommentIcon-2f8212cd.js";import{P as W}from"./PhoneIcon-d45a62b6.js";import{_ as qe,h as Oe,v as Pe,l as y,x as S,I as U,a as Fe,o as We,j as le,K as Ge,r as G,b as r,c as p,u as t,g as f,w as i,p as _,d as o,L as H,F as K,T as He,G as Ke,n as R,e as c,t as w,f as ie,H as re,B as Je}from"./index-d057f33a.js";import{N as Qe}from"./NoteModal-46cc4fb1.js";import{W as Xe}from"./WhatsAppIcon-3fd08937.js";import{I as Ye}from"./IndicatorIcon-c103771d.js";import{L as Ze}from"./LinkIcon-0f36a04b.js";import{A as ea}from"./ArrowUpRightIcon-f89323ee.js";import{S as aa}from"./Fields-6a34413d.js";import{_ as ta}from"./LayoutHeader-fe1f254b.js";import{_ as oa}from"./OrganizationModal-b81f6dbb.js";import{_ as sa}from"./AssignmentModal-7b9977f2.js";import{_ as na}from"./MultipleAvatar-9bfce769.js";import{C as la}from"./ContactModal-53eff54c.js";import{_ as ia}from"./views-fe454bb1.js";import{_ as de}from"./Section-1565df09.js";import{S as ra}from"./SLASection-51b98e40.js";import{_ as da}from"./CustomActions-fd13eb50.js";import{g as ma,u as ca,h,s as ua,i as pa,j as _a,_ as M,b as me,k as B,o as fa}from"./UserAvatar-e49c5291.js";import{g as va,_ as ga}from"./view-66caf033.js";import{s as ya}from"./statuses-72592e37.js";import{c as ce,w as ba}from"./settings-0248bbea.js";import{_ as xa}from"./Breadcrumbs.vue_vue_type_script_setup_true_lang-7b2c30ed.js";import{_ as ue}from"./Dropdown.vue_vue_type_script_setup_true_lang-bf1a1150.js";import"./DragVerticalIcon-87005af9.js";import"./Switch.vue_vue_type_script_setup_true_lang-3dc67c0d.js";import"./GroupByIcon-a605d43f.js";import"./CalendarIcon-236853ad.js";import"./callLog-55eb7109.js";import"./contacts-62bb23c5.js";import"./Dropdown-ddb0640f.js";import"./FadedScrollableDiv-9f66556a.js";import"./FileUploader-1f4a7957.js";import"./LeadsIcon-520efb00.js";import"./DealsIcon-15068e15.js";import"./EmailTemplateModal-9954264c.js";import"./TaskModal-817b477f.js";import"./NestedPopover-545deb9d.js";import"./AddressModal-ced65781.js";import"./QuickEntryModal-6386ea24.js";import"./OrganizationsIcon-321405d1.js";const ha={key:1,class:"flex h-full overflow-hidden"},Ca={class:"flex items-center justify-start gap-5 border-b p-5"},wa={class:"group relative size-12"},ka={class:"flex flex-col gap-2.5 truncate"},Ia={class:"truncate text-2xl font-medium"},Va={class:"flex gap-1.5"},za={key:1,class:"flex flex-1 flex-col justify-between overflow-hidden"},$a={class:"flex flex-col overflow-y-auto"},Da={key:0,class:"pr-2"},Sa={key:1},Ua={key:0,class:"flex min-h-20 flex-1 items-center justify-center gap-3 text-base text-gray-500"},Ma={class:"flex cursor-pointer items-center justify-between gap-2 pr-1 text-base leading-5 text-gray-700"},Ea=["onClick"],Ta={class:"truncate"},Aa={class:"flex items-center"},Ra={class:"flex flex-col gap-1.5 text-base text-gray-800"},Ba={class:"flex items-center gap-3 pb-1.5 pl-1 pt-4"},Na={class:"flex items-center gap-3 p-1 py-1.5"},La={key:0,class:"mx-2 h-px border-t border-gray-200"},ja={key:2,class:"flex h-20 items-center justify-center text-base text-gray-600"},qa={__name:"Deal",props:{dealId:{type:String,required:!0}},setup(pe){const{$dialog:_e,$socket:N,makeCall:fe}=ma(),{statusOptions:ve,getDealStatus:ge}=ya(),{isManager:ye}=ca(),k=Oe(),E=Pe(),v=pe,L=y([]),J=y([]),s=S({url:"crm.fcrm.doctype.crm_deal.api.get_deal",params:{name:v.dealId},cache:["deal",v.dealId],onSuccess:async a=>{a.organization&&(b.update({params:{doctype:"CRM Organization",name:a.organization}}),b.fetch());let e={doc:a,$dialog:_e,$socket:N,router:E,updateField:$,createToast:h,deleteDoc:ze,resource:{deal:s,dealContacts:g,fieldsLayout:V},call:U};ua(a);let l=await pa(a,e);L.value=l.actions||[],J.value=l.statuses||[]}}),b=S({url:"frappe.client.get",onSuccess:a=>s.data._organizationObj=a});Fe(()=>{if(N.on("crm_customer_created",()=>{h({title:__("Customer created successfully"),icon:"check",iconClasses:"text-green-600"})}),s.data){b.data=s.data._organizationObj;return}s.fetch()}),We(()=>{N.off("crm_customer_created")});const j=y(!1),q=y(!1),T=y(!1),A=y(!1),O=y({});function be(a,e,l){e=Array.isArray(a)?"":e,!xe(a,e)&&S({url:"frappe.client.set_value",params:{doctype:"CRM Deal",name:v.dealId,fieldname:a,value:e},auto:!0,onSuccess:()=>{s.reload(),j.value=!0,h({title:__("Deal updated"),icon:"check",iconClasses:"text-green-600"}),l==null||l()},onError:m=>{var z;h({title:__("Error updating deal"),text:__((z=m.messages)==null?void 0:z[0]),icon:"x",iconClasses:"text-red-600"})}})}function xe(a,e){var m;let l=s.data.fields_meta||{};return(m=l[a])!=null&&m.reqd&&!e?(h({title:__("Error Updating Deal"),text:__("{0} is a required field",[l[a].label]),icon:"x",iconClasses:"text-red-600"}),!0):!1}const he=le(()=>{var e;let a=[{label:__("Deals"),route:{name:"Deals"}}];if(k.query.view||k.query.viewType){let l=va(k.query.view,k.query.viewType,"CRM Deal");l&&a.push({label:__(l.label),icon:l.icon,route:{name:"Deals",params:{viewType:k.query.viewType},query:{view:k.query.view}}})}return a.push({label:((e=b.data)==null?void 0:e.name)||__("Untitled"),route:{name:"Deal",params:{dealId:s.data.name}}}),a});Ge(()=>{var a,e;return{title:((a=b.data)==null?void 0:a.name)||((e=s.data)==null?void 0:e.name)}});const P=le(()=>[{name:"Activity",label:__("Activity"),icon:Te},{name:"Emails",label:__("Emails"),icon:Ae},{name:"Comments",label:__("Comments"),icon:je},{name:"Calls",label:__("Calls"),icon:W,condition:()=>ce.value},{name:"Tasks",label:__("Tasks"),icon:He},{name:"Notes",label:__("Notes"),icon:Qe},{name:"WhatsApp",label:__("WhatsApp"),icon:Xe,condition:()=>ba.value}].filter(e=>e.condition?e.condition():!0)),{tabIndex:I}=Ee(P,"lastDealTab"),V=S({url:"crm.api.doc.get_sidebar_fields",cache:["fieldsLayout",v.dealId],params:{doctype:"CRM Deal",name:v.dealId},auto:!0,transform:a=>Ce(a)});function Ce(a){return a.forEach(e=>{e.name!="contacts_section"&&e.fields.forEach(l=>{l.name=="organization"&&(l.create=(m,z)=>{O.value.organization_name=m,q.value=!0,z()},l.link=m=>E.push({name:"Organization",params:{organizationId:m}}))})}),a}const F=y(!1),Q=y({});function we(a){let e=[{label:__("Remove"),icon:"trash-2",onClick:()=>ke(a.name)}];return a.is_primary||e.push({label:__("Set as Primary Contact"),icon:Je(aa,{class:"h-4 w-4"}),onClick:()=>Ie(a.name)}),e}async function X(a){await U("crm.fcrm.doctype.crm_deal.crm_deal.add_contact",{deal:v.dealId,contact:a})&&(g.reload(),h({title:__("Contact added"),icon:"check",iconClasses:"text-green-600"}))}async function ke(a){await U("crm.fcrm.doctype.crm_deal.crm_deal.remove_contact",{deal:v.dealId,contact:a})&&(g.reload(),h({title:__("Contact removed"),icon:"check",iconClasses:"text-green-600"}))}async function Ie(a){await U("crm.fcrm.doctype.crm_deal.crm_deal.set_primary_contact",{deal:v.dealId,contact:a})&&(g.reload(),h({title:__("Primary contact set"),icon:"check",iconClasses:"text-green-600"}))}const g=S({url:"crm.fcrm.doctype.crm_deal.api.get_deal_contacts",params:{name:v.dealId},cache:["deal_contacts",v.dealId],auto:!0,transform:a=>(a.forEach(e=>{e.opened=!1}),a)});function Ve(){var l;let a=(l=g.data)==null?void 0:l.find(m=>m.is_primary),e=a.mobile_no||null;if(!a){B(__("No primary contact set"));return}if(!e){B(__("No mobile number set"));return}fe(e)}function $(a,e,l){be(a,e,()=>{s.data[a]=e,l==null||l()})}async function ze(a){await U("frappe.client.delete",{doctype:"CRM Deal",name:a}),E.push({name:"Deals"})}const Y=y(null);function $e(){Y.value.emailBox.show=!0}return(a,e)=>{const l=G("FeatherIcon"),m=G("Button"),z=G("Badge");return r(),p(K,null,[t(s).data?(r(),f(ta,{key:0},{"left-header":i(()=>[o(t(xa),{items:he.value},{prefix:i(({item:n})=>[n.icon?(r(),f(Se,{key:0,icon:n.icon,class:"mr-2 h-4"},null,8,["icon"])):_("",!0)]),_:1},8,["items"])]),"right-header":i(()=>{var n;return[L.value?(r(),f(da,{key:0,actions:L.value},null,8,["actions"])):_("",!0),(r(),f(Ke(((n=t(s).data._assignedTo)==null?void 0:n.length)==1?"Button":"div"),null,{default:i(()=>[o(na,{avatars:t(s).data._assignedTo,onClick:e[0]||(e[0]=d=>T.value=!0)},null,8,["avatars"])]),_:1})),o(t(ue),{options:t(ve)("deal",$,J.value)},{default:i(({open:d})=>[o(m,{label:t(s).data.status,class:R(t(ge)(t(s).data.status).colorClass)},{prefix:i(()=>[o(Ye)]),suffix:i(()=>[o(l,{name:d?"chevron-up":"chevron-down",class:"h-4"},null,8,["name"])]),_:2},1032,["label","class"])]),_:1},8,["options"])]}),_:1})):_("",!0),t(s).data?(r(),p("div",ha,[o(t(ga),{modelValue:t(I),"onUpdate:modelValue":e[4]||(e[4]=n=>H(I)?I.value=n:null),tabs:P.value},{default:i(()=>[o(Re,{ref_key:"activities",ref:Y,doctype:"CRM Deal",tabs:P.value,reload:j.value,"onUpdate:reload":e[1]||(e[1]=n=>j.value=n),tabIndex:t(I),"onUpdate:tabIndex":e[2]||(e[2]=n=>H(I)?I.value=n:null),modelValue:t(s),"onUpdate:modelValue":e[3]||(e[3]=n=>H(s)?s.value=n:null)},null,8,["tabs","reload","tabIndex","modelValue"])]),_:1},8,["modelValue","tabs"]),o(Ue,{side:"right",class:"flex flex-col justify-between border-l"},{default:i(()=>{var n;return[c("div",{class:"flex h-10.5 cursor-copy items-center border-b px-5 py-2.5 text-lg font-medium",onClick:e[5]||(e[5]=d=>t(_a)(t(s).data.name))},w(a.__(t(s).data.name)),1),c("div",Ca,[o(t(M),{text:a.__("Organization logo")},{default:i(()=>{var d,C;return[c("div",wa,[o(t(me),{size:"3xl",class:"size-12",label:((d=t(b).data)==null?void 0:d.name)||a.__("Untitled"),image:(C=t(b).data)==null?void 0:C.organization_logo},null,8,["label","image"])])]}),_:1},8,["text"]),c("div",ka,[o(t(M),{text:((n=t(b).data)==null?void 0:n.name)||a.__("Set an organization")},{default:i(()=>{var d;return[c("div",Ia,w(((d=t(b).data)==null?void 0:d.name)||a.__("Untitled")),1)]}),_:1},8,["text"]),c("div",Va,[t(ce)?(r(),f(t(M),{key:0,text:a.__("Make a call")},{default:i(()=>[o(m,{class:"h-7 w-7",onClick:Ve},{default:i(()=>[o(W,{class:"h-4 w-4"})]),_:1})]),_:1},8,["text"])):_("",!0),o(t(M),{text:a.__("Send an email")},{default:i(()=>[o(m,{class:"h-7 w-7"},{default:i(()=>[o(ne,{class:"h-4 w-4",onClick:e[6]||(e[6]=d=>t(s).data.email?$e():t(B)(a.__("No email set")))})]),_:1})]),_:1},8,["text"]),o(t(M),{text:a.__("Go to website")},{default:i(()=>[o(m,{class:"h-7 w-7"},{default:i(()=>[o(Ze,{class:"h-4 w-4",onClick:e[7]||(e[7]=d=>t(s).data.website?t(fa)(t(s).data.website):t(B)(a.__("No website set")))})]),_:1})]),_:1},8,["text"])])])]),t(s).data.sla_status?(r(),f(ra,{key:0,modelValue:t(s).data,"onUpdate:modelValue":e[8]||(e[8]=d=>t(s).data=d),onUpdateField:$},null,8,["modelValue"])):_("",!0),t(V).data?(r(),p("div",za,[c("div",$a,[(r(!0),p(K,null,ie(t(V).data,(d,C)=>(r(),p("div",{key:d.label,class:R(["section flex flex-col p-3",{"border-b":C!==t(V).data.length-1}])},[o(de,{"is-opened":d.opened,label:d.label},{actions:i(()=>[d.contacts?(r(),p("div",Da,[o(ia,{value:"",doctype:"Contact",onChange:e[9]||(e[9]=x=>X(x)),onCreate:(x,D)=>{Q.value={first_name:x,company_name:t(s).data.organization},F.value=!0,D()}},{target:i(({togglePopover:x})=>[o(m,{class:"h-7 px-3",variant:"ghost",icon:"plus",onClick:D=>x()},null,8,["onClick"])]),_:1},8,["onCreate"])])):(!d.contacts&&C==1||C==0)&&t(ye)()?(r(),f(m,{key:1,variant:"ghost",class:"w-7 mr-2",onClick:e[10]||(e[10]=x=>A.value=!0)},{default:i(()=>[o(Le,{class:"h-4 w-4"})]),_:1})):_("",!0)]),default:i(()=>{var x,D,Z,ee,ae;return[d.fields?(r(),f(Be,{key:0,fields:d.fields,isLastSection:C==t(V).data.length-1,modelValue:t(s).data,"onUpdate:modelValue":e[11]||(e[11]=u=>t(s).data=u),onUpdate:$},null,8,["fields","isLastSection","modelValue"])):(r(),p("div",Sa,[(x=t(g))!=null&&x.loading&&((Z=(D=t(g))==null?void 0:D.data)==null?void 0:Z.length)==0?(r(),p("div",Ua,[o(Ne,{class:"h-4 w-4"}),c("span",null,w(a.__("Loading...")),1)])):(ae=(ee=t(g))==null?void 0:ee.data)!=null&&ae.length?(r(!0),p(K,{key:1},ie(t(g).data,(u,te)=>(r(),p("div",{key:u.name},[c("div",{class:R(["px-2 pb-2.5",[te==0?"pt-5":"pt-2.5"]])},[o(de,{"is-opened":u.opened},{header:i(({opened:De,toggle:oe})=>[c("div",Ma,[c("div",{class:"flex h-7 items-center gap-2 truncate",onClick:se=>oe()},[o(t(me),{label:u.full_name,image:u.image,size:"md"},null,8,["label","image"]),c("div",Ta,w(u.full_name),1),u.is_primary?(r(),f(z,{key:0,class:"ml-2",variant:"outline",label:a.__("Primary"),theme:"green"},null,8,["label"])):_("",!0)],8,Ea),c("div",Aa,[o(t(ue),{options:we(u)},{default:i(()=>[o(m,{icon:"more-horizontal",class:"text-gray-600",variant:"ghost"})]),_:2},1032,["options"]),o(m,{variant:"ghost",onClick:se=>t(E).push({name:"Contact",params:{contactId:u.name}})},{default:i(()=>[o(ea,{class:"h-4 w-4"})]),_:2},1032,["onClick"]),o(m,{variant:"ghost",onClick:se=>oe()},{default:i(()=>[o(l,{name:"chevron-right",class:R(["h-4 w-4 text-gray-900 transition-all duration-300 ease-in-out",{"rotate-90":De}])},null,8,["class"])]),_:2},1032,["onClick"])])])]),default:i(()=>[c("div",Ra,[c("div",Ba,[o(ne,{class:"h-4 w-4"}),re(" "+w(u.email),1)]),c("div",Na,[o(W,{class:"h-4 w-4"}),re(" "+w(u.mobile_no),1)])])]),_:2},1032,["is-opened"])],2),te!=t(g).data.length-1?(r(),p("div",La)):_("",!0)]))),128)):(r(),p("div",ja,w(a.__("No contacts added")),1))]))]}),_:2},1032,["is-opened","label"])],2))),128))])])):_("",!0)]}),_:1})])):_("",!0),o(oa,{modelValue:q.value,"onUpdate:modelValue":e[12]||(e[12]=n=>q.value=n),organization:O.value,"onUpdate:organization":e[13]||(e[13]=n=>O.value=n),options:{redirect:!1,afterInsert:n=>$("organization",n.name)}},null,8,["modelValue","organization","options"]),o(la,{modelValue:F.value,"onUpdate:modelValue":e[14]||(e[14]=n=>F.value=n),contact:Q.value,options:{redirect:!1,afterInsert:n=>X(n.name)}},null,8,["modelValue","contact","options"]),T.value?(r(),f(sa,{key:2,modelValue:T.value,"onUpdate:modelValue":e[15]||(e[15]=n=>T.value=n),assignees:t(s).data._assignedTo,"onUpdate:assignees":e[16]||(e[16]=n=>t(s).data._assignedTo=n),doc:t(s).data,doctype:"CRM Deal"},null,8,["modelValue","assignees","doc"])):_("",!0),A.value?(r(),f(Me,{key:3,modelValue:A.value,"onUpdate:modelValue":e[17]||(e[17]=n=>A.value=n),doctype:"CRM Deal",onReload:e[18]||(e[18]=()=>t(V).reload())},null,8,["modelValue"])):_("",!0)],64)}}},Tt=qe(qa,[["__scopeId","data-v-86ba3e6c"]]);export{Tt as default};
//# sourceMappingURL=Deal-939e5388.js.map
